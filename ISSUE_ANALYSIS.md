# é—®é¢˜åˆ†æï¼šè·å–ç»“æœå¤±è´¥ - ç»“æœä¸­æœªåŒ…å«å›¾ç‰‡URL

## ğŸ” é—®é¢˜æè¿°

**ç°è±¡**ï¼šæœ‰æ—¶å€™ä¼šå‡ºç°"è·å–ç»“æœå¤±è´¥: ç»“æœä¸­æœªåŒ…å«å›¾ç‰‡URL"ï¼Œä¸æ˜¯å¿…ç°çš„ã€‚

**è§¦å‘ä½ç½®**ï¼šå‰ç«¯ `fetchResult` å‡½æ•°ï¼Œç¬¬717è¡Œ
```javascript
if (!imageUrl) {
    throw new Error("ç»“æœä¸­æœªåŒ…å«å›¾ç‰‡URL");
}
```

## ğŸ“Š ä»£ç æµç¨‹åˆ†æ

### 1. ä»»åŠ¡å®Œæˆæµç¨‹

```
ComfyUI WebSocket æ”¶åˆ° execution_complete
  â†“
Worker: è®¾ç½® status = "completed" (ç«‹å³)
  â†“
Worker: await fetch_and_save_image(prompt_id) (å¼‚æ­¥ï¼Œå¯èƒ½éœ€è¦æ—¶é—´)
  â†“
Worker: æ›´æ–° task_status[prompt_id]["image_url"]
  â†“
å‰ç«¯è½®è¯¢: æ£€æµ‹åˆ° status = "completed"
  â†“
å‰ç«¯: ç«‹å³è°ƒç”¨ fetchResult(promptId)
  â†“
Worker: /result/{prompt_id} è¿”å› image_url
```

### 2. å…³é”®ä»£ç ä½ç½®

#### Worker ç«¯ (worker.py:117-142)
```python
elif msg_type in ["execution_complete", "execution_success"]:
    # æ‰§è¡Œå®Œæˆ
    if prompt_id in task_status:
        task_status[prompt_id]["status"] = "completed"  # âš ï¸ ç«‹å³è®¾ç½®
        task_status[prompt_id]["progress"] = {"value": 100, "max": 100}
        task_status[prompt_id]["message"] = "æ‰§è¡Œå®Œæˆ"
    
    # è·å–å›¾ç‰‡
    await fetch_and_save_image(prompt_id)  # âš ï¸ å¼‚æ­¥æ“ä½œï¼Œå¯èƒ½éœ€è¦æ—¶é—´
```

#### fetch_and_save_image å‡½æ•° (worker.py:173-234)
```python
async def fetch_and_save_image(prompt_id: str):
    try:
        # è·å–ä»»åŠ¡å†å²
        response = requests.get(f"{COMFYUI_BASE}/history/{prompt_id}", timeout=5)
        if response.status_code != 200:
            return  # âš ï¸ é™é»˜å¤±è´¥ï¼Œimage_url ä¿æŒä¸º None
        
        # ... æŸ¥æ‰¾å›¾ç‰‡è¾“å‡º ...
        
        # æ›´æ–°ä»»åŠ¡çŠ¶æ€
        if prompt_id in task_status:
            task_status[prompt_id]["image_url"] = image_url  # âš ï¸ å¯èƒ½ä¸º None
```

#### å‰ç«¯è½®è¯¢ (frontend/index.html:672-676)
```javascript
} else if (status === "completed") {
    // ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢ï¼Œè·å–ç»“æœ
    stopPolling();
    setStatus("ä»»åŠ¡å®Œæˆï¼Œè·å–ç»“æœ...");
    fetchResult(promptId);  // âš ï¸ ç«‹å³è°ƒç”¨ï¼Œå¯èƒ½ image_url è¿˜æ²¡è®¾ç½®
}
```

## ğŸ› å¯èƒ½çš„åŸå› 

### åŸå› 1ï¼šç«æ€æ¡ä»¶ï¼ˆæœ€å¯èƒ½ï¼‰â­â­â­â­â­

**é—®é¢˜**ï¼šçŠ¶æ€è®¾ç½®ä¸º `completed` å’Œ `image_url` è®¾ç½®ä¹‹é—´å­˜åœ¨æ—¶é—´å·®ã€‚

**æ—¶åº**ï¼š
1. `execution_complete` æ¶ˆæ¯åˆ°è¾¾
2. ç«‹å³è®¾ç½® `status = "completed"` (ç¬¬120è¡Œ)
3. å‰ç«¯è½®è¯¢æ£€æµ‹åˆ° `completed`ï¼Œç«‹å³è°ƒç”¨ `fetchResult`
4. ä½†æ­¤æ—¶ `fetch_and_save_image` å¯èƒ½è¿˜åœ¨æ‰§è¡Œä¸­ï¼š
   - æ­£åœ¨è¯·æ±‚ ComfyUI çš„ `/history` æ¥å£
   - æ­£åœ¨ä¸‹è½½å›¾ç‰‡
   - æ­£åœ¨ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°
5. `image_url` è¿˜æ˜¯ `None`ï¼Œå¯¼è‡´å‰ç«¯æŠ¥é”™

**è§¦å‘æ¡ä»¶**ï¼š
- å‰ç«¯è½®è¯¢é¢‘ç‡é«˜ï¼ˆ1.5ç§’ä¸€æ¬¡ï¼‰
- `fetch_and_save_image` æ‰§è¡Œè¾ƒæ…¢ï¼ˆç½‘ç»œå»¶è¿Ÿã€ComfyUI å“åº”æ…¢ï¼‰
- æ­£å¥½åœ¨çŠ¶æ€æ›´æ–°å’Œå›¾ç‰‡è·å–ä¹‹é—´è½®è¯¢

### åŸå› 2ï¼šfetch_and_save_image é™é»˜å¤±è´¥ â­â­â­â­

**é—®é¢˜**ï¼š`fetch_and_save_image` ä¸­çš„é”™è¯¯è¢«é™é»˜å¤„ç†ï¼Œå¯¼è‡´ `image_url` ä¿æŒä¸º `None`ã€‚

**å¯èƒ½çš„å¤±è´¥ç‚¹**ï¼š
1. **è·å–å†å²å¤±è´¥** (ç¬¬177-179è¡Œ)
   ```python
   if response.status_code != 200:
       return  # âš ï¸ é™é»˜è¿”å›ï¼Œimage_url ä¸º None
   ```

2. **å†å²ä¸­æ‰¾ä¸åˆ° prompt_id** (ç¬¬182-183è¡Œ)
   ```python
   if prompt_id not in data:
       return  # âš ï¸ é™é»˜è¿”å›ï¼Œimage_url ä¸º None
   ```

3. **æ‰¾ä¸åˆ°å›¾ç‰‡è¾“å‡º** (ç¬¬189-226è¡Œ)
   - å·¥ä½œæµæ²¡æœ‰å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹
   - å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹ç»“æ„ä¸ç¬¦åˆé¢„æœŸ
   - `outputs` ä¸ºç©ºæˆ–æ²¡æœ‰ `images` å­—æ®µ

4. **ä¿å­˜å›¾ç‰‡å¤±è´¥** (ç¬¬223-224è¡Œ)
   ```python
   except Exception as e:
       print(f"ä¿å­˜å›¾ç‰‡å¤±è´¥: {e}")  # âš ï¸ åªæ‰“å°ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
   ```

**è§¦å‘æ¡ä»¶**ï¼š
- ComfyUI å†å²è®°å½•å»¶è¿Ÿï¼ˆåˆšå®Œæˆæ—¶æŸ¥è¯¢ä¸åˆ°ï¼‰
- å·¥ä½œæµé…ç½®é—®é¢˜ï¼ˆæ²¡æœ‰å›¾ç‰‡è¾“å‡ºï¼‰
- æ–‡ä»¶ç³»ç»Ÿæƒé™é—®é¢˜ï¼ˆæ— æ³•ä¿å­˜å›¾ç‰‡ï¼‰

### åŸå› 3ï¼šComfyUI å†å²è®°å½•å»¶è¿Ÿ â­â­â­

**é—®é¢˜**ï¼šComfyUI å¯èƒ½åœ¨å‘é€ `execution_complete` åï¼Œè¿˜éœ€è¦æ—¶é—´æ‰èƒ½é€šè¿‡ `/history` æ¥å£æŸ¥è¯¢åˆ°ç»“æœã€‚

**æ—¶åº**ï¼š
1. ComfyUI å‘é€ `execution_complete` æ¶ˆæ¯
2. Worker ç«‹å³æŸ¥è¯¢ `/history/{prompt_id}`
3. ä½† ComfyUI å¯èƒ½è¿˜åœ¨å†™å…¥å†å²è®°å½•
4. è¿”å›ç©ºæ•°æ®æˆ–æœªå®Œæˆçš„æ•°æ®
5. `fetch_and_save_image` æ‰¾ä¸åˆ°å›¾ç‰‡ï¼Œé™é»˜è¿”å›

**è§¦å‘æ¡ä»¶**ï¼š
- ComfyUI å†™å…¥å†å²è®°å½•æœ‰å»¶è¿Ÿ
- é«˜è´Ÿè½½æ—¶å»¶è¿Ÿæ›´æ˜æ˜¾

### åŸå› 4ï¼šå›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹é—®é¢˜ â­â­

**é—®é¢˜**ï¼šæŸäº›å·¥ä½œæµå¯èƒ½æ²¡æœ‰å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹ï¼Œæˆ–è€…å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹çš„ç»“æ„ä¸ç¬¦åˆé¢„æœŸã€‚

**å¯èƒ½çš„æƒ…å†µ**ï¼š
- å·¥ä½œæµé…ç½®é”™è¯¯ï¼Œæ²¡æœ‰ SaveImage èŠ‚ç‚¹
- å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹çš„ ID ä¸åœ¨é¢„æœŸçš„ä½ç½®
- å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹çš„æ•°æ®ç»“æ„å˜åŒ–

### åŸå› 5ï¼šå‰ç«¯è½®è¯¢æ—¶æœºé—®é¢˜ â­â­

**é—®é¢˜**ï¼šå‰ç«¯åœ¨çŠ¶æ€å˜ä¸º `completed` åç«‹å³è°ƒç”¨ `fetchResult`ï¼Œæ²¡æœ‰ç­‰å¾… `image_url` è®¾ç½®ã€‚

**å½“å‰é€»è¾‘**ï¼š
```javascript
} else if (status === "completed") {
    stopPolling();  // âš ï¸ ç«‹å³åœæ­¢è½®è¯¢
    fetchResult(promptId);  // âš ï¸ ç«‹å³è·å–ç»“æœ
}
```

**é—®é¢˜**ï¼šå¦‚æœ `image_url` è¿˜æ²¡è®¾ç½®ï¼Œå°±ä¼šæŠ¥é”™ã€‚

## ğŸ“ˆ é—®é¢˜å¤ç°æ¦‚ç‡åˆ†æ

### é«˜æ¦‚ç‡åœºæ™¯
1. **ç½‘ç»œå»¶è¿Ÿ**ï¼šComfyUI å“åº”æ…¢ï¼Œ`fetch_and_save_image` æ‰§è¡Œæ—¶é—´é•¿
2. **ComfyUI è´Ÿè½½é«˜**ï¼šå†å²è®°å½•å†™å…¥å»¶è¿Ÿ
3. **å‰ç«¯è½®è¯¢æ­£å¥½åœ¨ä¸´ç•Œç‚¹**ï¼šçŠ¶æ€åˆšæ›´æ–°ä¸º `completed`ï¼Œä½†å›¾ç‰‡è¿˜æ²¡è·å–

### ä½æ¦‚ç‡åœºæ™¯
1. **å·¥ä½œæµé…ç½®é”™è¯¯**ï¼šæ²¡æœ‰å›¾ç‰‡è¾“å‡ºèŠ‚ç‚¹ï¼ˆè¿™ç§æƒ…å†µåº”è¯¥æ˜¯å¿…ç°çš„ï¼‰
2. **æ–‡ä»¶ç³»ç»Ÿé—®é¢˜**ï¼šæ— æ³•ä¿å­˜å›¾ç‰‡ï¼ˆè¿™ç§æƒ…å†µåº”è¯¥æ˜¯å¿…ç°çš„ï¼‰

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ·»åŠ æ—¥å¿—éªŒè¯ç«æ€æ¡ä»¶
åœ¨ `fetch_and_save_image` å‡½æ•°ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š
```python
print(f"[{prompt_id}] å¼€å§‹è·å–å›¾ç‰‡...")
print(f"[{prompt_id}] è·å–å†å²: {response.status_code}")
print(f"[{prompt_id}] æ‰¾åˆ°å›¾ç‰‡: {filename}")
print(f"[{prompt_id}] ä¿å­˜å›¾ç‰‡: {local_path}")
print(f"[{prompt_id}] è®¾ç½® image_url: {image_url}")
```

### 2. æ£€æŸ¥å‰ç«¯è½®è¯¢æ—¶æœº
åœ¨å‰ç«¯æ·»åŠ æ—¥å¿—ï¼š
```javascript
console.log("çŠ¶æ€:", status, "image_url:", data.image_url);
```

### 3. æ£€æŸ¥ ComfyUI å†å²è®°å½•å»¶è¿Ÿ
åœ¨ `fetch_and_save_image` ä¸­æ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå¦‚æœç¬¬ä¸€æ¬¡æŸ¥è¯¢å¤±è´¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ã€‚

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®ï¼ˆæš‚ä¸å®ç°ï¼‰

### æ–¹æ¡ˆ1ï¼šå»¶è¿Ÿè®¾ç½® completed çŠ¶æ€
åœ¨ `image_url` è®¾ç½®æˆåŠŸåå†è®¾ç½® `status = "completed"`ã€‚

### æ–¹æ¡ˆ2ï¼šå‰ç«¯é‡è¯•æœºåˆ¶
å¦‚æœ `image_url` ä¸ºç©ºï¼Œå‰ç«¯ç»§ç»­è½®è¯¢çŠ¶æ€ï¼Œç›´åˆ° `image_url` æœ‰å€¼ã€‚

### æ–¹æ¡ˆ3ï¼šfetch_and_save_image é‡è¯•
å¦‚æœç¬¬ä¸€æ¬¡è·å–å¤±è´¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ã€‚

### æ–¹æ¡ˆ4ï¼šçŠ¶æ€æœºæ”¹è¿›
å¼•å…¥ä¸­é—´çŠ¶æ€ï¼Œå¦‚ `fetching_image`ï¼Œè¡¨ç¤ºæ­£åœ¨è·å–å›¾ç‰‡ã€‚

### æ–¹æ¡ˆ5ï¼šåŒæ­¥ç­‰å¾…
åœ¨è®¾ç½® `completed` çŠ¶æ€å‰ï¼Œç­‰å¾… `fetch_and_save_image` å®Œæˆã€‚

## ğŸ“ æ€»ç»“

**æœ€å¯èƒ½çš„åŸå› **ï¼š**ç«æ€æ¡ä»¶** - çŠ¶æ€è®¾ç½®ä¸º `completed` å’Œ `image_url` è®¾ç½®ä¹‹é—´å­˜åœ¨æ—¶é—´å·®ï¼Œå‰ç«¯åœ¨ `image_url` è®¾ç½®ä¹‹å‰å°±è·å–äº†ç»“æœã€‚

**æ¬¡è¦åŸå› **ï¼š`fetch_and_save_image` é™é»˜å¤±è´¥ï¼Œå¯¼è‡´ `image_url` ä¿æŒä¸º `None`ã€‚

**å»ºè®®**ï¼šä¼˜å…ˆè§£å†³ç«æ€æ¡ä»¶é—®é¢˜ï¼Œç„¶åæ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ã€‚

